# 全部重构的架构设想

## lunabot工厂

lunabot工厂是最外层的封装，直接提供给用户，应当是可实例化的，提供实例化方法的模块

- 实例化：加载环境变量、配置文件、由此创建并维护一个新的上下文
  实例化应提供以下可选参数：连接方式，使用的标准，没有可以fallback到配置文件
  ~~应当把工厂除了init之外的成员作为元表继承~~
  这部分应当放至lunabot实例层级的环境
  **关于上下文的设想**
  使用元表的__index实现，一层套一层，按照优先级考虑，全局表应该在最外面，如果本层没有就自动fallback到上一层
- *也许这个应该叫作环境*
- version：版本号

## 日志模块

使用从monlog暴改的，传入文件描述符的log
日志模块本身应当是与lunabot工厂同级的，但是会在使用的时候实例化多个层级的log，比如bot的log，插件的log
这部分也放到维护的环境里，如果本层级没有log就使用上一层的log

- 接口包括接受文件描述符的init，设置log等级，和log函数
- 特别的，每一个层级应当添加一个prefix，log函数应当加入这个新的参数

## 配置模块

此模块用于广泛地进行配置的读取比较与解析
与日志模块同样的级别

- 提供一个config接口，接受full-config-default和user-config和可选的CONFIG函数
  如未提供CONFIG函数则使用自带的默认CONFIG函数，即将full-config-default设为user-config的__index元表

## utils

此模块包含各种实用工具

- 将同步方法包装为异步

## Driver

用于提供连接

## Adapter

用于提供ob11等协议适配

### lunabot

从oop的角度这是lunabot的单个实例

应当包含以下环境：

- 账户信息表，在bot启动时初始化
  - 账户id
  - 头像链接（可以是一个用于获取头像的接口）
- 实例化的时间戳
- bot配置表
  - 日志相关
    - 日志文件路径
    - 日志等级
  - 连接方式
    - 连接方式相关的参数
  - 使用的标准
- bot启停的接口，还有暂停之类的对于bot生命周期管理的接口

## 关于整个lunabot的核心

1. 由于决定基于cqueue，于是核心应当是一个main_loop或者类似的东西
  于是主要任务就是将整个lunabot拆解成几个队列
  现在的问题是这几个队列该如何耦合在一起？我认为第二点恰好可以解决这个问题（虽然我也不知道他为啥能 蜜汁自信。jpg）
2. 使用__index嵌套实现的环境层级
